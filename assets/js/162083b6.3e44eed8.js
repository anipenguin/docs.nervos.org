"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2530],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),h=i,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||o;return n?a.createElement(m,r(r({ref:t},c),{},{components:n})):a.createElement(m,r({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2825:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>p,default:()=>m,frontMatter:()=>s,metadata:()=>c,toc:()=>u});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=n(4996),l=(n(9960),["components"]),s={id:"tx-pool-rbf",title:"Replace-By-Fee (RBF)"},p=void 0,c={unversionedId:"essays/tx-pool-rbf",id:"essays/tx-pool-rbf",title:"Replace-By-Fee (RBF)",description:"What is RBF?",source:"@site/docs/essays/tx-pool-rbf.md",sourceDirName:"essays",slug:"/essays/tx-pool-rbf",permalink:"/docs/essays/tx-pool-rbf",draft:!1,editUrl:"https://github.com/nervosnetwork/docs-new/tree/develop/website/docs/essays/tx-pool-rbf.md",tags:[],version:"current",frontMatter:{id:"tx-pool-rbf",title:"Replace-By-Fee (RBF)"},sidebar:"Essays",previous:{title:"Transaction Pool",permalink:"/docs/essays/tx-pool"},next:{title:"The Back-of-Envelope Calculation of the Transaction Confirmation Number",permalink:"/docs/essays/tx-confirmation"}},d={},u=[{value:"What is RBF?",id:"what-is-rbf",level:2},{value:"Why Use RBF?",id:"why-use-rbf",level:2},{value:"Examples of RBF",id:"examples-of-rbf",level:2},{value:"RBF Check Rules",id:"rbf-check-rules",level:2},{value:"How to Use RBF in CKB",id:"how-to-use-rbf-in-ckb",level:2},{value:"How to Enable and Disable RBF",id:"how-to-enable-and-disable-rbf",level:3},{value:"Calculating the Minimum RBF Fee",id:"calculating-the-minimum-rbf-fee",level:3},{value:"Using RBF via the CKB RPC",id:"using-rbf-via-the-ckb-rpc",level:3}],h={toc:u};function m(e){var t=e.components,n=(0,i.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"what-is-rbf"},"What is RBF?"),(0,o.kt)("p",null,"When a transaction is broadcasted to the network, all nodes verify its validity. If the transaction is valid, they add it to their transaction pool (tx-pool) and relay it to other nodes for further propagation. The transaction will stay in the tx-pool in a pending state until it is mined into a block."),(0,o.kt)("p",null,"Under certain conditions, such as during a period of congestion, a transaction may reside in the tx-pool for an extended period of time. This typically occurs when blocks are consistently full, and the fee attached to the transaction is not high enough to be included during a high traffic period since transactions with the highest fees are selected first."),(0,o.kt)("p",null,"There are two common resolutions for this issue. If the congestion resolves itself, all the transactions in the tx-pool may eventually go through. However, there is no guarantee this will happen or how long it will take. The second option is to initiate a new transaction with a fee that is high enough to prioritize it for faster inclusion."),(0,o.kt)("p",null,"The strategy used to replace an existing transaction in the tx-pool with a higher fee one is known as Replace-By-Fee (RBF). This was first introduced by Bitcoin in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki"},"BIP 125"),"."),(0,o.kt)("p",null,'To use RBF to replace an existing transaction in the tx-pool with a new one, the new transaction must share at least one input with the old transaction and include a sufficiently high RBF fee. (RBF fees are outlined below.) All other inputs and outputs in the transaction can be different. The new transaction will replace the old transaction in the tx-pool, and the old transaction and its descendents will be removed from tx-pool with status "Rejected".'),(0,o.kt)("h2",{id:"why-use-rbf"},"Why Use RBF?"),(0,o.kt)("p",null,"RBF allows for adjustment of pending transactions and can be beneficial in several scenarios. RBF allows pending transactions to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Accelerate Transaction Confirmation"),": RBF allows transactions that are not confirming fast enough to increase their fee to get higher prioritization. This can happen if an incorrect fee was paid or if network conditions change suddenly, resulting in a fee that is too low under current conditions."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Transaction Cancellation"),": RBF enables the cancellation of a pending transaction. This is done by submitting a new transaction that consumes the same inputs as the old transaction but redirects the funds back to the sender instead of the original recipient."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Transaction Batching"),": RBF allows multiple small batchable transactions to be combined into a single large transaction. This leads to better optimization, reducing the total fees paid for all batched transactions, and potentially resulting in quicker inclusion of all batched transactions.")),(0,o.kt)("h2",{id:"examples-of-rbf"},"Examples of RBF"),(0,o.kt)("p",null,"Let's examine a few examples of RBF, starting with the most basic one."),(0,o.kt)("img",{src:(0,r.Z)("img/rbf.png"),width:"50%"}),(0,o.kt)("p",null,"In the example above, ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," is a pending transaction in the tx-pool, and ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b")," is a new transaction which may replace it. Both transactions include ",(0,o.kt)("inlineCode",{parentName:"p"},"input-1"),". This creates a conflict as the same input cannot be used in two different transactions. If ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b")," satisfies all the RBF requirements, it will replace ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," in the tx-pool."),(0,o.kt)("p",null,"Next, let's examine a more complex scenario where multiple old transactions are replaced by a single new transaction."),(0,o.kt)("img",{src:(0,r.Z)("img/rbf-merge.png"),width:"60%"}),(0,o.kt)("p",null,"In the example above, transaction ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b"),", and their descendants ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-c")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-d"),", are in the tx-pool. A new transaction, ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-e")," has been created with two conflicted inputs, ",(0,o.kt)("inlineCode",{parentName:"p"},"input-2")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"input-3"),". If ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-e")," meets the requirements of RBF, it will replace ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b"),", and consequently, it will also replace their descendants ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-c")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-d"),"."),(0,o.kt)("p",null,"Now, let's explore another method for accelerating a pending transaction, known as ",(0,o.kt)("inlineCode",{parentName:"p"},"Child-Pays-For-Parent")," (CPFP)."),(0,o.kt)("img",{src:(0,r.Z)("img/rbf-cpfp.png"),width:"70%"}),(0,o.kt)("p",null,"In the example above, ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," is in the tx-pool and the fee is not high enough to confirm. We speed this up using two different examples."),(0,o.kt)("p",null,"On the left, we use RBF to replace ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b"),". Both ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b")," have the same output, but ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b")," includes a higher fee to ensure faster confirmation."),(0,o.kt)("p",null,"On the right, we use CPFP to speed up the confirmation of ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," by submitting tx-b, which does not have any conflicting inputs. Instead of using RBF to replace ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a"),", we create ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b")," as a decendent of ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," and include a higher fee with ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b"),". If the combined fees from ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-a")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"tx-b")," are high enough, it will allow both to confirm."),(0,o.kt)("h2",{id:"rbf-check-rules"},"RBF Check Rules"),(0,o.kt)("p",null,"RBF introduces extra procedures to validate incoming new transactions and remove old transactions from the tx-pool if the criteria for RBF is met."),(0,o.kt)("img",{src:(0,r.Z)("img/rbf-process.png"),width:"60%"}),(0,o.kt)("p",null,"RBF includes several check rules to safeguard the system by ensuring proper functionality and preventing malicious misuse of the feature:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The old transaction to be replaced must still be in a pending status, meaning it is in the tx-pool but is not confirmed."),(0,o.kt)("li",{parentName:"ol"},"The new transaction must not include any inputs that are still unconfirmed, unless the inputs on the new transaction match the inputs on the old transaction that is being replaced."),(0,o.kt)("li",{parentName:"ol"},"The new transaction must include a sufficiently high fee that is higher than the old transaction it is replacing, meeting the RBF minimum replacement fee rate requirement. (RBF fees are outlined below.)"),(0,o.kt)("li",{parentName:"ol"},"The old transaction which will be replaced must not have more than 100 decendent transactions in the tx-pool."),(0,o.kt)("li",{parentName:"ol"},"The new transaction must not include any inputs or cell_deps that are decendants (outputs) of the old transaction. This would be invalid because replacing the old transaction means its outputs will no longer exist, and therefore they cannot be included in any future transactions.")),(0,o.kt)("p",null,"These rules are implementated in the function ",(0,o.kt)("inlineCode",{parentName:"p"},"check_rbf()")," in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/nervosnetwork/ckb/blob/2f44fb0ca6a73ae77b4805b8f087a3b9913ac8f5/tx-pool/src/pool.rs#L527-L629"},"pool.rs"),"."),(0,o.kt)("h2",{id:"how-to-use-rbf-in-ckb"},"How to Use RBF in CKB"),(0,o.kt)("h3",{id:"how-to-enable-and-disable-rbf"},"How to Enable and Disable RBF"),(0,o.kt)("p",null,"RBF support was added to CKB in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/nervosnetwork/ckb/releases/tag/v0.112.1"},"v0.112.1"),", and it is enabled by default."),(0,o.kt)("p",null,"RBF is enabled and disabled in ",(0,o.kt)("inlineCode",{parentName:"p"},"ckb.toml")," using the ",(0,o.kt)("inlineCode",{parentName:"p"},"min_rbf_rate")," parameter, which also controls the minimum extra fee required to activate RBF."),(0,o.kt)("p",null,"The parameter for RBF in ",(0,o.kt)("inlineCode",{parentName:"p"},"ckb.toml")," is ",(0,o.kt)("inlineCode",{parentName:"p"},"min_rbf_rate"),", indicating the minimum extra fee rate for RBF. The ",(0,o.kt)("inlineCode",{parentName:"p"},"min_rbf_rate")," value is expressed in Shannons/KB, the same as ",(0,o.kt)("inlineCode",{parentName:"p"},"min_fee_rate"),"."),(0,o.kt)("p",null,"To disable RBF on your CKB node, set ",(0,o.kt)("inlineCode",{parentName:"p"},"min_rbf_rate")," to a value less or equal with ",(0,o.kt)("inlineCode",{parentName:"p"},"min_fee_rate"),"."),(0,o.kt)("p",null,"In the example below, RBF is enabled. These are the default values in ",(0,o.kt)("inlineCode",{parentName:"p"},"ckb.toml"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},"min_fee_rate = 1_000\nmin_rbf_rate = 1_500\n")),(0,o.kt)("p",null,"In the example below, RBF is disabled because ",(0,o.kt)("inlineCode",{parentName:"p"},"min_rbf_rate")," is less than ",(0,o.kt)("inlineCode",{parentName:"p"},"min_fee_rate"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},"min_fee_rate = 1_000\nmin_rbf_rate = 0\n")),(0,o.kt)("h3",{id:"calculating-the-minimum-rbf-fee"},"Calculating the Minimum RBF Fee"),(0,o.kt)("p",null,"The formula for calculating the minimum RBF replacement fee for a new transaction is as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"min_replace_fee = sum(replaced_tx_fee) + (min_rbf_rate * new_tx_size)\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"sum(replaced_tx_fee)")," is the sum of the fees from all old transactions that are being directly replaced by the new transaction."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"(min_rbf_rate * new_tx_size)")," is the ",(0,o.kt)("inlineCode",{parentName:"p"},"min_rbf_rate")," from ",(0,o.kt)("inlineCode",{parentName:"p"},"ckb.toml")," and it is expressed in Shannons/KB. This is multiplied by the size of the new transaction."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"min_replace_fee")," is the total of all the fees being removed from the tx-pool, plus the new transaction calculated at the RBF rate. A single new transaction can replace multiple old transactions in the tx-pool, so it only makes sense that the replacement new transaction offers more fees than those it is replacing."),(0,o.kt)("h3",{id:"using-rbf-via-the-ckb-rpc"},"Using RBF via the CKB RPC"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"min_replace_fee")," field has been added to the result of ",(0,o.kt)("inlineCode",{parentName:"p"},"get_transaction")," as a simple way to get the required fees to replace a single transaction with one of an identical size."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Note: If your new transaction is a different size, or it is a more complicated replacement of multiple transactions in the tx-pool, you must use the formula above to properly calculate the RBF fees.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": 42,\n  "jsonrpc": "2.0",\n  "method": "get_transaction",\n  "params": [\n    "0xa0ef4eb5f4ceeb08a4c8524d84c5da95dce2f608e0ca2ec8091191b0f330c6e3"\n  ]\n}\n')),(0,o.kt)("p",null,"An example response:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": 42,\n  "jsonrpc": "2.0",\n  "result": {\n    "transaction": {\n      "cell_deps": [\n        ...\n      ],\n      "inputs": [\n        ...\n      ],\n      "outputs": [\n        ...\n      ],\n      "outputs_data": [\n        "0x"\n      ],\n      "version": "0x0",\n      "witnesses": [\n        ...\n      ]\n    },\n    "cycles": "0x219",\n    "time_added_to_pool" : "0x187b3d137a1",\n    "fee": "0x5f5e100",\n    "min_replace_fee": "0x5f5e26b",\n    "tx_status": {\n      "block_hash": null,\n      "status": "pending",\n      "reason": null\n    }\n  }\n}\n')),(0,o.kt)("p",null,"To invoke an RBF transaction, you would use the ",(0,o.kt)("inlineCode",{parentName:"p"},"send_transaction")," method in the exact same way as creating a new transaction:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": 42,\n  "jsonrpc": "2.0",\n  "method": "send_transaction",\n  "params": [\n    {\n      "cell_deps": [\n        ...\n      ],\n      "header_deps": [\n        ...\n      ],\n      "inputs": [\n        ...\n      ],\n      "outputs": [\n        ...\n      ],\n      "outputs_data": [\n        "0x"\n      ],\n      "version": "0x0",\n      "witnesses": [\n        ...\n      ]\n    },\n    "passthrough"\n  ]\n}\n')),(0,o.kt)("p",null,"Once the RBF transaction is submitted, the RBF rules will be checked. If successful, the transaction hash will be returned in the same format as when creating a regular transaction:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": 42,\n  "jsonrpc": "2.0",\n  "result": "0xa0ef4eb5f4ceeb08a4c8524d84c5da95dce2f608e0ca2ec8091191b0f330c6e3"\n}\n')),(0,o.kt)("p",null,"If the RBF transaction fails the check, an error will be returned:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": 42,\n  "jsonrpc": "2.0",\n  "error": {\n    "code": -301,\n    "message": "RBFRjected: ..."\n  }\n}\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"message")," field contains the reason why RBF is rejected. For example, if the transaction fee is not high enough, the message would be similar to this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},"Tx's current fee is 1000000000, expect it to >= 2000000363 to replace old txs.\n")))}m.isMDXComponent=!0}}]);